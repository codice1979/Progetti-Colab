name: Run POC + SuperTrend Daily

on:
  schedule:
    # Ogni giorno dal lunedì al venerdì alle 23:55 UTC
    - cron: '55 23 * * 1-5'
  workflow_dispatch:   # avvio manuale

jobs:
  run-master:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3️⃣ Installa dipendenze compatibili senza TA-Lib
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            pandas \
            numpy \
            openpyxl \
            yfinance \
            lxml

      # 4️⃣ Esegui master.py con la nuova logica SuperTrend
      - name: Run Master Script (SuperTrend senza TA-Lib)
        run: |
          python master.py --poc_period 20y --soglia_poc 15

      # 5️⃣ Upload output come artifacts
      - name: Upload Output Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: poc-supertrend-output
          path: data/output/

      # 6️⃣ Genera HTML con link cliccabile all'ultimo artifact
      - name: Generate Latest Artifact HTML
        run: |
          ARTIFACT_NAME="poc-supertrend-output"
          
          # Recupera l'ID dell'ultimo artifact tramite GitHub API
          ARTIFACT_ID=$(gh api repos/${{ github.repository }}/actions/artifacts --jq ".artifacts | map(select(.name==\"$ARTIFACT_NAME\")) | sort_by(.created_at) | last(.id)")
          
          if [ -z "$ARTIFACT_ID" ]; then
            echo "❌ Artifact non trovato"
            exit 1
          fi
          
          # URL diretto al ZIP dell'ultimo artifact
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip"
          
          # Genera file HTML con link cliccabile
          HTML_FILE="latest_artifact.html"
          echo "<!DOCTYPE html>
<html>
<head><title>Latest Artifact</title></head>
<body>
<h3>Ultimo ZIP del workflow:</h3>
<a href=\"$ARTIFACT_URL\" target=\"_blank\">Scarica ZIP</a>
</body>
</html>" > $HTML_FILE
          
          echo "✅ HTML generato: $HTML_FILE"

      # 7️⃣ Upload HTML come artifact separato
      - name: Upload HTML Artifact
        uses: actions/upload-artifact@v4
        with:
          name: latest-artifact-link
          path: latest_artifact.html
